# Контейнеризированный модуль для генерации отчетов в формате docx

## Функционал

Модуль в реальном времени отслеживает таблицу "report" в привязанной 
БД (PostgreSQL) на наличие запросов, готовых к обработке. Готовность запроса 
к обработке определяется значением в поле "status_id". Значение status_id 
в соответветствии с которым происходит выборка запросов передаётся в скрипт 
посредством функции main.py>main_cycle в виде параметра target_status_id, 
успешные запросы помечаются значением параметра success_status_id который так же
находится в сигнатуре данной функции.

Данные (csv-файлы), на основании которых происходит формирование отчета 
автоматически загружаются из удалёленного хранилища (S3 MinIo) 
считываются и преобразуются в необходимые форматы. Путь
к данным для выгрузки подтягивается из БД (таблица report).

Пример входных данных, используемых при формировании отчетов представлен
[здесь](docx_report_generator/example/input_data/)

Результатом работы модуля является 
[docx-файл](docx_report_generator/example/report/Отчет_текстовая_кампания_2254.docx)
который загружается в S3-хранилище по пути, определенному в атрибутах
класса Processor (main.py)

Для работы программы требуется: 
- наличие базы данных со структурой, 
определенной в [database/models.py](docx_report_generator/database/models.py).
Строка подключения к БД определяется в файле [database/db.py](database/db.py).
Для работы с БД используется библиотека SQLAlchemy.
- развернутое S3-хранилище (MinIo)

# Структура проекта

Модуль генерации представлен в виде директории docx_report_generator. 
Основные составляющие:

- main.py - точка входа в программу
- report_generator.py - скрипт для генерации отчета
- s3_storage.py - модуль для работы с удалённым хранилищем
- settings.py - модуль для загрузки параметров конфигурации из переменных окружения
- database - пакет из двух модулей, в котором происходит параметров
подключения к БД и моделей (структуры) таблиц

# Необходимые компоненты 
- Python 3.11^
- PostgreSQL 17.4
- Виртуальное окружение
- файл окружения с наименованием .env

# Требования к переменным окружения
Переменные окружения подгружаются из файла .env с помощью библиотеки dotenv.
В файле окружения должны находиться следующие переменные:
- переменные базы данных:
  - DB_NAME - имя БД
  - DB_USER - имя пользователя БД
  - DB_PASSWORD - пароль
  - DB_HOST - адрес сервера БД
  - DB_PORT - порт БД
- переменные S3-хранилища (MinIo)
  - S3_ENDPOINT_URL - основной адрес хранилища 
  - S3_OUTER_ENDPOINT_URL - внешний адрес хранилища 
  - S3_ACCESS_KEY - логин от хранилища
  - S3_SECRET_KEY - пароль от хранилища
  - S3_BUCKET_NAME - имя корзины с которой будет работать API 
  - S3_SECURE - параметр безопасности

# Демонстрация
## Локальный запуск
### Создание виртуального окружения
windows power shell:
- Создание: ```python -m venv <имя_окружения>```
- Запуск: ```<имя_окружения>/Scripts/activate```

### Установка необходимых библиотек
Необходиые библиотеки представлены в файле requirements.txt. 
Для установки требуется выполнить команду: 

(winwows power shell): ```pip install -r requirements.txt```

# Запуск

При условии что параметры подключения к БД и S3 - хранилищу корректно указаны в переменных
окружения, для локальной работы достаточно запустить 
модуль main.py: ```python docx_report_generator/main.py```

# Docker
Для демонстрации работы так же представлен файл [docker-compose](docker-compose.yaml) 
состоящий из 3 сервисов:
1. Генератор отчетов
2. База данных
   - образ postgres:17.4
   - для сохранения данных между запусками используется том (volume) pg_data
3. MinIo хранилище
   - образ quay.io/minio/minio (официальный образ MinIO)
   - для сохранения данных между запусками используется том minio_data

А так же написан простой скрипт для загрузки демонстрационых файлов с данными
[load_data.py](load_data.py)

Запуск: ```docker compose up```

Загрузка демонстрационных данных в хранилище: локально запустить файл load_data.py:
```python load_data.py```

Остановка: ```docker compose stop```
